#!/usr/bin/env zunit

@setup {
  source ./m.zsh
  source ./test_helper.zsh
  ROOT_DIR=$(pwd)
  echo "fixtures/gitignored/ignored/*" > .gitignore
}

@teardown {
  cd $ROOT_DIR
  rm .gitignore
}

@test 'mg - basic strings with single file' {
  cd fixtures/basic

  run mg hello

  assert $state equals 0
  assert "$output" is_empty

  run mg two

  assert $state equals 0
  assert "${#lines}" equals 1
  assert "$output" same_as "numbers.txt$(cyan :)$(red two)"

  run mg teen

  assert $state equals 0
  assert "${#lines}" equals 3
  assert "numbers.txt$(cyan :)thir$(red teen)" in "$output"
  assert "numbers.txt$(cyan :)four$(red teen)" in "$output"
  assert "numbers.txt$(cyan :)fif$(red teen)" in "$output"
}

@test 'mg - nested deeply files' {
  cd fixtures/nested

  run mg hello

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "dir1/dir2/dir3/hello.txt$(cyan :)dir3$(red hello)" in "$output"
  assert "dir1/hello.txt$(cyan :)dir1$(red hello)" in "$output"
}

@test 'mg - gitignored dirs' {
  cd fixtures/gitignored

  run mg hello

  assert $state equals 0
  assert "${#lines}" equals 1
  assert "$output" same_as "not_ignored/not_ignored.txt$(cyan :)$(red hello) not ignored"
}

@test 'mg - very long lines are filtered' {
  cd fixtures/basic

  run mg one

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "numbers.txt$(cyan :)$(red one)" in "$output"
  assert "$output" matches 'long_lines.txt.*:.*\.{100}.*one.*'
}

@test 'mg - case insensitive' {
  cd fixtures/basic

  run mg three

  assert $state equals 0
  assert "${#lines}" equals 7
  assert "numbers.txt$(cyan :)$(red three)" in "$output"
  assert "cases.txt$(cyan :)$(red three)" in "$output"
  assert "cases.txt$(cyan :)$(red Three)" in "$output"
  assert "cases.txt$(cyan :)$(red tHree)" in "$output"
  assert "cases.txt$(cyan :)$(red thRee)" in "$output"
  assert "cases.txt$(cyan :)$(red thrEe)" in "$output"
  assert "cases.txt$(cyan :)$(red threE)" in "$output"
}

@test 'mg - smartcase' {
  cd fixtures/basic

  run mg Three

  assert $state equals 0
  assert "${#lines}" equals 1
  assert "cases.txt$(cyan :)$(red Three)" in "$output"
}

@test 'mg -c - case sensitive flag' {
  cd fixtures/basic
  
  run mg -c three

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "cases.txt$(cyan :)$(red three)" in "$output"
  assert "numbers.txt$(cyan :)$(red three)" in "$output"
}
