#!/usr/bin/env zunit

@setup {
  source ./m.zsh
  source ./test_helper.zsh
  ROOT_DIR=$(pwd)
  echo "fixtures/gitignored/ignored/*" > .gitignore
}

@teardown {
  cd $ROOT_DIR
  rm .gitignore
}

@test 'mg - basic strings with single file' {
  cd fixtures/basic

  run mg hello

  assert $state equals 1
  assert "$output" is_empty

  run mg two

  assert $state equals 0
  assert "${#lines}" equals 1
  assert "$output" same_as "numbers.txt:two"

  run mg teen

  assert $state equals 0
  assert "${#lines}" equals 3
  assert "numbers.txt:thirteen" in "$output"
  assert "numbers.txt:fourteen" in "$output"
  assert "numbers.txt:fifteen" in "$output"
}

@test 'mg - nested deeply files' {
  cd fixtures/nested

  run mg hello

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "dir1/dir2/dir3/hello.txt:dir3hello" in "$output"
  assert "dir1/hello.txt:dir1hello" in "$output"
}

@test 'mg - gitignored dirs' {
  cd fixtures/gitignored

  run mg hello

  assert $state equals 0
  assert "${#lines}" equals 1
  assert "$output" same_as "not_ignored/not_ignored.txt:hello not ignored"
}

@test 'mg - very long lines are filtered' {
  cd fixtures/basic

  run mg one

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "numbers.txt:one" in "$output"
  assert "$output" matches 'long_lines.txt:\.{100}one'
}

@test 'mg - case insensitive' {
  cd fixtures/basic

  run mg three

  assert $state equals 0
  assert "${#lines}" equals 7
  assert "numbers.txt:three" in "$output"
  assert "cases.txt:three" in "$output"
  assert "cases.txt:Three" in "$output"
  assert "cases.txt:tHree" in "$output"
  assert "cases.txt:thRee" in "$output"
  assert "cases.txt:thrEe" in "$output"
  assert "cases.txt:threE" in "$output"
}

@test 'mg - smartcase' {
  cd fixtures/basic

  run mg Three

  assert $state equals 0
  assert "${#lines}" equals 1
  assert "cases.txt:Three" in "$output"
}

@test 'mg - -c case sensitive flag' {
  cd fixtures/basic
  
  run mg -c three

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "cases.txt:three" in "$output"
  assert "numbers.txt:three" in "$output"
}
