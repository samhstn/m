#!/usr/bin/env zunit

@setup {
  source ./m.zsh
  source ./test_helper.zsh
  ROOT_DIR=$(pwd)
  M_TEST=true
  echo "fixtures/gitignored/ignored/*" > .gitignore
}

@teardown {
  cd $ROOT_DIR
  if [ -f .gitignore ];then
    rm .gitignore
  fi
}

@test 'mo - without a previously run mg command' {
  M_HISTORY_TEST='ls'

  run mo

  assert $state equals 1
  assert "$output" same_as "cannot find recently run mg command"
}

@test 'mo - non integer first argument displays mo usage' {
  M_HISTORY_TEST='mg three'
  run mo -h

  assert $state equals 1
  assert "$output" contains "usage"
  assert "${#lines}" equals 4
}

@test 'mo - no args: opens all files from last mg' {
  cd fixtures/basic

  M_HISTORY_TEST='mg three\nmg other'

  mo

  run m_called_with

  assert $state equals 0
  assert ${#lines} equals 2
  assert "cases.txt" in "$output"
  assert "numbers.txt" in "$output"
}

@test 'mo 1 - opens 1st mg output 1' {
  cd fixtures/basic

  M_HISTORY_TEST='mg three\nmg other'

  mo 1

  run m_called_with

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "${lines[1]}" same_as "cases.txt"
  assert "${lines[2]}" same_as "+1"
}

@test 'mo 1 -opens 1st mg output 2' {
  cd fixtures/basic

  M_HISTORY_TEST='mg one\nmg other'

  mo 1

  run m_called_with

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "${lines[1]}" same_as "long_lines.txt"
  assert "${lines[2]}" same_as "+1"
}

@test 'mo 2 - opens 2nd mg output 1' {
  cd fixtures/basic

  M_HISTORY_TEST='mg three\nmg other'

  mo 2

  run m_called_with

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "${lines[1]}" same_as "cases.txt"
  assert "${lines[2]}" same_as "+2"
}

@test 'mo 2 - opens 2nd mg output 2' {
  cd fixtures/basic

  M_HISTORY_TEST='mg one\nmg other'

  mo 2

  run m_called_with

  assert $state equals 0
  assert "${#lines}" equals 2
  assert "${lines[1]}" same_as "numbers.txt"
  assert "${lines[2]}" same_as "+1"
}
